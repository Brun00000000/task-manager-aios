# Story 2.5: Filters & Full-Text Search

## Status
Done

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — Filter Bar + Search + URL Sync + pg_trgm
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** filtrar e buscar minhas tarefas,
**so that** eu encontre rapidamente o que preciso mesmo com muitas tarefas cadastradas.

---

## Acceptance Criteria

1. Barra de filtros na pagina `/tasks` com: Status (multi-select), Prioridade (multi-select), Categoria (multi-select), Prazo (hoje / esta semana / atrasadas / sem prazo)
2. Filtros ativos exibidos como chips removiveis abaixo da barra de busca
3. Botao "Limpar filtros" visivel quando ha filtros ativos
4. Campo de busca executa full-text search em titulo e descricao via `pg_trgm` no Supabase
5. Busca com debounce de 300ms (nao dispara query a cada tecla)
6. URL atualizada com parametros de filtro/busca (compartilhavel e preservado no reload)
7. Filtros e busca combinados funcionam corretamente juntos
8. Contagem de resultados exibida ("Exibindo 12 de 47 tarefas")

---

## Scope

**IN:**
- `src/features/tasks/components/FilterBar.tsx` — barra de filtros multi-select + prazo + busca
- `src/features/tasks/components/FilterChips.tsx` — chips removiveis de filtros ativos
- `src/features/tasks/hooks/useTaskFilters.ts` — gerenciar estado de filtros + URL sync (useSearchParams + useRouter)
- `src/lib/repositories/TaskRepository.ts` — atualizar `list()` para suportar full-text search com pg_trgm
- Ativar extensao `pg_trgm` no Supabase (migration SQL)
- Debounce: implementar `useDebounce` hook simples ou usar `use-debounce` package
- Atualizar `src/app/(dashboard)/tasks/page.tsx` para incluir FilterBar + FilterChips + contagem

**OUT:**
- Filtros salvos por usuario (persistent preferences)
- Ordenacao por colunas (alem da ordem manual)
- Busca em categorias
- Filtro por assignee (Epic 3)

---

## Dependencies

- **Story 2.1** — useTasks, TaskRepository.list(), pagina /tasks existem
- **Story 2.3** — useCategories disponivel para popular filtro de categoria
- **pg_trgm:** extensao do PostgreSQL ja disponivel no Supabase — necessario apenas habilitar e criar indice

---

## Complexity

**Estimativa:** 3 story points (S)

---

## Business Value

Com muitas tarefas a busca e filtros sao essenciais para usabilidade. URL sync permite compartilhar views filtradas e mantem estado ao recarregar.

---

## Risks

- **pg_trgm via Supabase:** Habilitar extensao com `create extension if not exists pg_trgm` via Supabase Dashboard SQL Editor ou migration. Criar indice GIN para performance.
- **URL sync com App Router:** useSearchParams requer Suspense boundary — envolver componente que usa searchParams em Suspense.
- **Filtros combinados:** SQL com multiplos WHERE opcionais — construir query dinamicamente no Repository.

---

## Definition of Done

- [x] Todos os ACs verificados manualmente
- [x] `npm run lint && npm run typecheck && npm run test` passando
- [x] Busca full-text funciona (testar com palavras parciais)
- [x] URL atualiza ao aplicar filtros e recupera ao recarregar pagina
- [x] Debounce de 300ms verificado (Network tab: query nao dispara a cada tecla)
- [x] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [x] **Task 1: Habilitar pg_trgm no Supabase** (AC: 4)
  - [x] 1.1 Acessar Supabase Dashboard > SQL Editor
  - [x] 1.2 Executar: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`
  - [x] 1.3 Criar indice: `CREATE INDEX IF NOT EXISTS tasks_title_trgm_idx ON tasks USING gin(title gin_trgm_ops);`
  - [x] 1.4 Criar indice: `CREATE INDEX IF NOT EXISTS tasks_desc_trgm_idx ON tasks USING gin(description gin_trgm_ops);`
  - [x] 1.5 Registrar SQL em `supabase/migrations/` para versionamento

- [x] **Task 2: useDebounce hook** (AC: 5)
  - [x] 2.1 Criar `src/hooks/useDebounce.ts` — hook simples com useState + useEffect + setTimeout
  - [x] 2.2 Parametros: value, delay (default 300ms)

- [x] **Task 3: useTaskFilters hook** (AC: 1, 2, 3, 6, 7)
  - [x] 3.1 Criar `src/features/tasks/hooks/useTaskFilters.ts`
  - [x] 3.2 Ler filtros de useSearchParams (status[], priority[], category_id[], due, search)
  - [x] 3.3 Funcoes: setFilter, removeFilter, clearFilters — atualizam URL com router.push
  - [x] 3.4 Computar hasActiveFilters (para mostrar/esconder "Limpar filtros")
  - [x] 3.5 Computar activeFilterChips para renderizar chips removiveis

- [x] **Task 4: Atualizar TaskRepository.list()** (AC: 4, 7)
  - [x] 4.1 Adicionar suporte a parametro `search` na query
  - [x] 4.2 Full-text search: `.or(\`title.ilike.%${search}%,description.ilike.%${search}%\`)` (ou ilike + pg_trgm)
  - [x] 4.3 Garantir todos os filtros existentes (status, priority, category_id, due) funcionam combinados

- [x] **Task 5: FilterBar** (AC: 1, 4, 5)
  - [x] 5.1 Criar `FilterBar.tsx` — layout horizontal com todos os filtros
  - [x] 5.2 Campo de busca (Input) com icone Search do Lucide
  - [x] 5.3 Debounce na busca: usar useDebounce antes de atualizar URL
  - [x] 5.4 Multi-select de Status: checkboxes para todo, in_progress, done
  - [x] 5.5 Multi-select de Prioridade: checkboxes para low, medium, high, urgent
  - [x] 5.6 Multi-select de Categoria: usar dados do useCategories
  - [x] 5.7 Select de Prazo: hoje, esta semana, atrasadas, sem prazo

- [x] **Task 6: FilterChips** (AC: 2, 3)
  - [x] 6.1 Criar `FilterChips.tsx` — renderiza chips para cada filtro ativo
  - [x] 6.2 Chip com label legivel (ex: "Status: A fazer") + botao X para remover
  - [x] 6.3 Botao "Limpar filtros" ao lado dos chips (visivel quando hasActiveFilters)

- [x] **Task 7: Contagem de resultados** (AC: 8)
  - [x] 7.1 API GET /api/tasks ja retorna `meta.total` — usar para contagem total
  - [x] 7.2 Exibir "Exibindo N de M tarefas" abaixo da FilterBar
  - [x] 7.3 Ocultar quando nao ha filtros e resultado = total

- [x] **Task 8: Atualizar pagina /tasks** (AC: 1-8)
  - [x] 8.1 Adicionar FilterBar acima da lista
  - [x] 8.2 Adicionar FilterChips entre barra e lista
  - [x] 8.3 Passar filtros do useTaskFilters para useTasks
  - [x] 8.4 Envolver em Suspense (necessario para useSearchParams no App Router)
  - [x] 8.5 Exibir contagem de resultados

- [x] **Task 9: Verificacao final** (AC: 1-8)
  - [x] 9.1 `npm run lint && npm run typecheck && npm run test` passando
  - [x] 9.2 Build limpo
  - [x] 9.3 File List completo abaixo

---

## Dev Notes

### URL Sync Pattern (App Router)

```typescript
'use client'
import { useSearchParams, useRouter, usePathname } from 'next/navigation'

export function useTaskFilters() {
  const searchParams = useSearchParams()
  const router = useRouter()
  const pathname = usePathname()

  const setFilter = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString())
    params.set(key, value)
    router.push(`${pathname}?${params.toString()}`)
  }

  // ...
}
```

### Full-text com Supabase client

```typescript
// Usando ilike para simplicidade (pg_trgm melhora performance, nao a sintaxe)
if (search) {
  query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`)
}
```

### useDebounce simples

```typescript
export function useDebounce<T>(value: T, delay = 300): T {
  const [debounced, setDebounced] = useState(value)
  useEffect(() => {
    const t = setTimeout(() => setDebounced(value), delay)
    return () => clearTimeout(t)
  }, [value, delay])
  return debounced
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |
| 2026-02-21 | 1.1 | Status Draft para Ready — GO (10/10). pg_trgm e URL sync com Suspense boundary bem especificados. Instrução de migration incluída. Pronta para implementação. | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa. lint ✅ typecheck ✅ tests 8/8 ✅ build ✅. Status → Done. | @dev (Dex) |

---

## File List

**A criar:**
- src/hooks/useDebounce.ts
- src/features/tasks/hooks/useTaskFilters.ts
- src/features/tasks/components/FilterBar.tsx
- src/features/tasks/components/FilterChips.tsx
- supabase/migrations/[timestamp]_enable_pg_trgm.sql

**A modificar:**
- src/lib/repositories/TaskRepository.ts — full-text search em list()
- src/app/(dashboard)/tasks/page.tsx — FilterBar + FilterChips + contagem + Suspense
- docs/stories/2.5.filters-search.story.md
