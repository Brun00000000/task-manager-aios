# Story 1.3: User Authentication

## Status
InProgress

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
  - auth-flow-validation
```

> **Work Type:** Code/Features/Logic â€” Auth UI + Middleware + State Management
> **Supporting Agent:** nenhum â€” story autocontida

---

## Story

**As a** visitante,
**I want** criar uma conta e fazer login,
**so that** eu possa acessar meu gerenciador de tarefas pessoal de forma segura e isolada dos dados de outros usuÃ¡rios.

---

## Acceptance Criteria

1. PÃ¡gina de signup com campos: email, senha, confirmaÃ§Ã£o de senha â€” validaÃ§Ã£o via Zod (email vÃ¡lido, senha mÃ­nimo 8 chars, senhas coincidem)
2. PÃ¡gina de login com campos: email e senha
3. Mensagens de erro claras e especÃ­ficas: email jÃ¡ cadastrado, credenciais invÃ¡lidas, senha fraca
4. Login bem-sucedido redireciona para `/dashboard`
5. SessÃ£o JWT gerenciada pelo Supabase Auth com expiraÃ§Ã£o de 7 dias â€” armazenada em cookie httpOnly
6. Logout encerra sessÃ£o e redireciona para `/login`
7. Rotas autenticadas (`/dashboard` e subpaths) redirecionam para `/login` se sem sessÃ£o vÃ¡lida
8. Rotas de auth (`/login`, `/signup`) redirecionam para `/dashboard` se usuÃ¡rio jÃ¡ autenticado

---

## Scope

**IN:**
- Middleware Edge de autenticaÃ§Ã£o (`src/middleware.ts`)
- PÃ¡ginas de login e signup com route group `(auth)`
- Layout do dashboard com route group `(dashboard)` + placeholder `/dashboard`
- Feature `auth`: contract, Zustand store, hooks (login, signup, logout), componentes de form
- Schemas Zod para login e signup
- Instalar dependÃªncias: `zod`, `react-hook-form`, `@hookform/resolvers`, `zustand`
- Testes unitÃ¡rios dos schemas Zod e hooks
- Testes E2E dos fluxos crÃ­ticos (signup, login, logout, redirect)

**OUT:**
- RecuperaÃ§Ã£o de senha / "esqueci minha senha"
- AutenticaÃ§Ã£o social (Google, GitHub)
- PÃ¡gina de configuraÃ§Ãµes de conta
- ValidaÃ§Ã£o de email / email confirmation (Supabase envia por padrÃ£o â€” nÃ£o implementar UI)
- Avatar upload
- PÃ¡gina `/dashboard` completa (apenas placeholder â€” serÃ¡ implementada no Epic 2)

---

## Dependencies

- **Story 1.1** âœ… â€” Next.js + Tailwind + shadcn/ui + CI/CD configurados
- **Story 1.2** âœ… â€” Supabase SDK (`src/lib/supabase/client.ts`, `src/lib/supabase/server.ts`) + variÃ¡veis de ambiente no `.env.local`
- **Supabase Cloud** âœ… â€” Projeto configurado com Auth habilitado, trigger `handle_new_user` criado

---

## Complexity

**Estimativa:** 5 story points (M)

---

## Business Value

Sem autenticaÃ§Ã£o, o Task Manager nÃ£o pode ser usado. Esta story desbloqueia o MVP completo: usuÃ¡rios reais podem criar conta, acessar seus dados isolados por RLS e usar a aplicaÃ§Ã£o de forma segura.

---

## Risks

- **Middleware SSR e cookies:** `@supabase/ssr` exige padrÃ£o especÃ­fico de `getAll`/`setAll` â€” nÃ£o usar a API antiga `createMiddlewareClient`. Ver Dev Notes para cÃ³digo exato.
- **Redirect loops:** Middleware mal configurado pode causar loop `/login â†’ /dashboard â†’ /login`. Usar `getUser()` (nÃ£o `getSession()`) no middleware e garantir que rotas pÃºblicas estejam mapeadas corretamente.
- **Zustand hidrataÃ§Ã£o:** Store client-side pode causar hydration mismatch. Inicializar com `null` e popular no `useEffect` ou via `onAuthStateChange`.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente (signup, login, logout, redirects)
- [ ] `npm run lint && npm run typecheck && npm run test` passando sem erros
- [ ] Testes E2E passando (signup flow + login flow + logout)
- [ ] Sem console errors em produÃ§Ã£o ou dev
- [ ] File List completo na story

---

## ğŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI nÃ£o estÃ¡ habilitado no ambiente atual.
> RevisÃ£o de qualidade via process manual + CI pipeline (lint + typecheck + test).

---

## Tasks / Subtasks

- [ ] **Task 1: Instalar dependÃªncias de forms, validaÃ§Ã£o e estado** (prerequisite)
  - [ ] 1.1 Instalar: `npm install zod react-hook-form @hookform/resolvers zustand`
  - [ ] 1.2 Verificar que `npm run typecheck` continua passando apÃ³s instalaÃ§Ã£o
  - [ ] 1.3 Verificar versÃµes: zod 3.x, react-hook-form 7.x, zustand 5.x

- [ ] **Task 2: Schemas Zod de Auth** (AC: 1, 3)
  - [ ] 2.1 Criar `src/lib/schemas/auth.schema.ts` com `loginSchema` e `signupSchema`
  - [ ] 2.2 `loginSchema`: `{ email: z.string().email(), password: z.string().min(1) }`
  - [ ] 2.3 `signupSchema`: `{ email: z.string().email(), password: z.string().min(8, 'Senha deve ter no mÃ­nimo 8 caracteres'), confirmPassword: z.string() }` com `.refine()` para validar senhas iguais
  - [ ] 2.4 Exportar types: `LoginFormData`, `SignupFormData`
  - [ ] 2.5 Escrever testes unitÃ¡rios: `src/lib/schemas/auth.schema.test.ts` (valid/invalid cases)

- [ ] **Task 3: Auth Contract e Store (Zustand)** (AC: 4, 5, 6)
  - [ ] 3.1 Criar `src/features/auth/auth.contract.ts` com interface `AuthUser { id, email, fullName }`
  - [ ] 3.2 Criar `src/features/auth/store/auth.store.ts` com Zustand store:
        `useAuthStore` com state: `{ user: AuthUser | null, isLoading: boolean }` e actions: `setUser`, `clearUser`
  - [ ] 3.3 Store deve inicializar `user: null` para evitar hydration mismatch

- [ ] **Task 4: Auth Hooks** (AC: 3, 4, 6)
  - [ ] 4.1 Criar `src/features/auth/hooks/useSignup.ts`:
        - Chamar `supabase.auth.signUp({ email, password })`
        - Mapear erros Supabase â†’ mensagens PT-BR (ver Dev Notes â€” Error Mapping)
        - Sucesso: `router.push('/dashboard')`
  - [ ] 4.2 Criar `src/features/auth/hooks/useLogin.ts`:
        - Chamar `supabase.auth.signInWithPassword({ email, password })`
        - Mapear erros Supabase â†’ mensagens PT-BR
        - Sucesso: `router.push('/dashboard')`
  - [ ] 4.3 Criar `src/features/auth/hooks/useLogout.ts`:
        - Chamar `supabase.auth.signOut()`
        - `clearUser()` no store
        - `router.push('/login')`
  - [ ] 4.4 Criar `src/features/auth/hooks/useAuthUser.ts`:
        - `onAuthStateChange` para sincronizar user no Zustand store
        - Retornar `{ user, isLoading }`

- [ ] **Task 5: Middleware de Auth** (AC: 7, 8)
  - [ ] 5.1 Criar `src/middleware.ts` com padrÃ£o `@supabase/ssr` (ver Dev Notes â€” Middleware)
  - [ ] 5.2 Definir `PUBLIC_ROUTES = ['/', '/api/health']` e `AUTH_ROUTES = ['/login', '/signup']`
  - [ ] 5.3 Regra 1: usuÃ¡rio sem sessÃ£o em rota privada â†’ redirect `/login`
  - [ ] 5.4 Regra 2: usuÃ¡rio com sessÃ£o em `AUTH_ROUTES` â†’ redirect `/dashboard`
  - [ ] 5.5 Exportar `config.matcher` para excluir `_next/static`, `_next/image`, `favicon.ico`
  - [ ] 5.6 Testar manualmente: acessar `/dashboard` sem login â†’ redireciona para `/login`
  - [ ] 5.7 Testar manualmente: acessar `/login` autenticado â†’ redireciona para `/dashboard`

- [ ] **Task 6: Layout e pÃ¡ginas de Auth** (AC: 1, 2)
  - [ ] 6.1 Criar `src/app/(auth)/layout.tsx` â€” layout centralizado (flex, min-h-screen, items-center, justify-center + fundo sutil)
  - [ ] 6.2 Criar `src/app/(auth)/login/page.tsx` â€” importa `LoginForm`
  - [ ] 6.3 Criar `src/app/(auth)/signup/page.tsx` â€” importa `SignupForm`
  - [ ] 6.4 Criar `src/features/auth/components/LoginForm.tsx`:
        - `useForm` + `zodResolver(loginSchema)` + `useLogin`
        - Campos: email (Input), password (Input type="password")
        - Submit button com loading state
        - Link para `/signup`
        - Exibir `errorMessage` em `<p>` vermelho
  - [ ] 6.5 Criar `src/features/auth/components/SignupForm.tsx`:
        - `useForm` + `zodResolver(signupSchema)` + `useSignup`
        - Campos: email, password, confirmPassword
        - Submit button com loading state
        - Link para `/login`
        - Exibir `errorMessage` em `<p>` vermelho
  - [ ] 6.6 Todos os forms devem usar componentes shadcn: `Input`, `Button`, `Label` (jÃ¡ instalados)

- [ ] **Task 7: Layout do Dashboard e placeholder** (AC: 4, 6)
  - [ ] 7.1 Criar `src/app/(dashboard)/layout.tsx`:
        - Verificar sessÃ£o server-side via `createServerClient` (redundÃ¢ncia â€” middleware jÃ¡ protege, mas boa prÃ¡tica)
        - Header mÃ­nimo com botÃ£o "Sair" que aciona logout
        - Renderizar `children`
  - [ ] 7.2 Criar `src/app/(dashboard)/dashboard/page.tsx`:
        - Server Component simples: exibir "Dashboard â€” em breve" com nome do usuÃ¡rio
        - Buscar `user` via `supabase.auth.getUser()` server-side

- [ ] **Task 8: Testes E2E** (AC: 1-8)
  - [ ] 8.1 Criar `e2e/auth.spec.ts` com os fluxos:
        - `test('signup com novo usuÃ¡rio â†’ redireciona para /dashboard')` â€” usar email Ãºnico gerado dinamicamente
        - `test('login com credenciais vÃ¡lidas â†’ redireciona para /dashboard')`
        - `test('login com credenciais invÃ¡lidas â†’ exibe mensagem de erro')`
        - `test('logout â†’ redireciona para /login')`
        - `test('rota /dashboard sem sessÃ£o â†’ redireciona para /login')`
  - [ ] 8.2 Executar `npm run test:e2e` e confirmar todos os testes passam

- [ ] **Task 9: VerificaÃ§Ã£o final** (AC: 1-8)
  - [ ] 9.1 Executar `npm run lint && npm run typecheck && npm run test` â€” todos devendo passar
  - [ ] 9.2 Verificar fluxo completo manualmente: signup â†’ dashboard â†’ logout â†’ login â†’ dashboard
  - [ ] 9.3 Confirmar que `/dashboard` sem sessÃ£o redireciona para `/login`
  - [ ] 9.4 Confirmar que `/login` com sessÃ£o ativa redireciona para `/dashboard`
  - [ ] 9.5 Garantir que File List estÃ¡ completo e todos os checkboxes marcados

---

## Dev Notes

### Contexto

Story 1.3 implementa a camada de autenticaÃ§Ã£o completa. O Supabase Auth jÃ¡ estÃ¡ configurado na Story 1.2. O SDK (`client.ts`, `server.ts`) estÃ¡ disponÃ­vel em `src/lib/supabase/`.

**IMPORTANTE:** Usar `@supabase/ssr` (jÃ¡ instalado) para todos os clientes server-side. NÃƒO usar `@supabase/auth-helpers-nextjs` (deprecated).

### Stack de Auth

| Camada | Tecnologia | Arquivo |
|--------|-----------|---------|
| JWT + Session | Supabase Auth | Via SDK |
| Cookie httpOnly | `@supabase/ssr` | `src/lib/supabase/server.ts` |
| Edge Guard | Next.js Middleware | `src/middleware.ts` |
| Client State | Zustand | `src/features/auth/store/auth.store.ts` |
| Forms | React Hook Form + Zod | `src/features/auth/components/` |

### CÃ³digo: Middleware (`src/middleware.ts`)
[Source: architecture/task-manager-architecture.md#10-frontend-architecture]

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

const PUBLIC_ROUTES = ['/', '/api/health']
const AUTH_ROUTES = ['/login', '/signup']

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          )
          supabaseResponse = NextResponse.next({ request })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANTE: Usar getUser() e nÃ£o getSession() â€” getUser() valida o JWT no servidor
  const { data: { user } } = await supabase.auth.getUser()

  const pathname = request.nextUrl.pathname
  const isPublic = PUBLIC_ROUTES.some(r => pathname === r || pathname.startsWith('/api/'))
  const isAuthRoute = AUTH_ROUTES.some(r => pathname.startsWith(r))

  if (!user && !isPublic && !isAuthRoute) {
    const url = request.nextUrl.clone()
    url.pathname = '/login'
    return NextResponse.redirect(url)
  }

  if (user && isAuthRoute) {
    const url = request.nextUrl.clone()
    url.pathname = '/dashboard'
    return NextResponse.redirect(url)
  }

  return supabaseResponse
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

### CÃ³digo: Auth Schemas (`src/lib/schemas/auth.schema.ts`)

```typescript
import { z } from 'zod'

export const loginSchema = z.object({
  email: z.string().email('Email invÃ¡lido'),
  password: z.string().min(1, 'Senha obrigatÃ³ria'),
})

export const signupSchema = z.object({
  email: z.string().email('Email invÃ¡lido'),
  password: z.string().min(8, 'Senha deve ter no mÃ­nimo 8 caracteres'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'As senhas nÃ£o coincidem',
  path: ['confirmPassword'],
})

export type LoginFormData = z.infer<typeof loginSchema>
export type SignupFormData = z.infer<typeof signupSchema>
```

### CÃ³digo: Zustand Auth Store (`src/features/auth/store/auth.store.ts`)

```typescript
import { create } from 'zustand'
import type { AuthUser } from '../auth.contract'

interface AuthState {
  user: AuthUser | null
  isLoading: boolean
  setUser: (user: AuthUser | null) => void
  clearUser: () => void
  setLoading: (loading: boolean) => void
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  isLoading: true,
  setUser: (user) => set({ user, isLoading: false }),
  clearUser: () => set({ user: null, isLoading: false }),
  setLoading: (loading) => set({ isLoading: loading }),
}))
```

### CÃ³digo: Auth Contract (`src/features/auth/auth.contract.ts`)

```typescript
export interface AuthUser {
  id: string
  email: string
  fullName: string | null
}
```

### Error Mapping â€” Supabase â†’ PT-BR
[Tratar nos hooks de useLogin e useSignup]

```typescript
function mapAuthError(error: AuthError): string {
  const msg = error.message.toLowerCase()
  if (msg.includes('invalid login credentials')) return 'Email ou senha incorretos'
  if (msg.includes('email already registered') || msg.includes('user already registered'))
    return 'Este email jÃ¡ estÃ¡ cadastrado'
  if (msg.includes('password should be at least')) return 'Senha deve ter no mÃ­nimo 8 caracteres'
  if (msg.includes('email not confirmed')) return 'Confirme seu email antes de fazer login'
  if (msg.includes('rate limit')) return 'Muitas tentativas. Aguarde alguns minutos.'
  return 'Ocorreu um erro. Tente novamente.'
}
```

### Estrutura de Pastas a Criar Nesta Story
[Source: architecture/task-manager-architecture.md#10-frontend-architecture]

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”œâ”€â”€ layout.tsx            â† layout centralizado
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â””â”€â”€ (dashboard)/
â”‚       â”œâ”€â”€ layout.tsx            â† header + logout
â”‚       â””â”€â”€ dashboard/
â”‚           â””â”€â”€ page.tsx          â† placeholder
â”œâ”€â”€ features/
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ auth.contract.ts
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ LoginForm.tsx
â”‚       â”‚   â””â”€â”€ SignupForm.tsx
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â”œâ”€â”€ useLogin.ts
â”‚       â”‚   â”œâ”€â”€ useSignup.ts
â”‚       â”‚   â”œâ”€â”€ useLogout.ts
â”‚       â”‚   â””â”€â”€ useAuthUser.ts
â”‚       â””â”€â”€ store/
â”‚           â””â”€â”€ auth.store.ts
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ schemas/
â”‚       â”œâ”€â”€ auth.schema.ts
â”‚       â””â”€â”€ auth.schema.test.ts
â””â”€â”€ middleware.ts
```

**NÃƒO criar nesta story:** `src/features/tasks/`, `src/features/categories/`, `src/features/dashboard/`, `src/lib/repositories/`, componentes de tarefa ou categoria.

### PadrÃ£o de Form com React Hook Form + Zod

```typescript
'use client'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { loginSchema, type LoginFormData } from '@/lib/schemas/auth.schema'

export function LoginForm() {
  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  })

  const onSubmit = async (data: LoginFormData) => {
    // chamar useLogin hook
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Input {...register('email')} type="email" placeholder="email@exemplo.com" />
      {errors.email && <p className="text-red-500 text-sm">{errors.email.message}</p>}
      {/* ... */}
      <Button type="submit" disabled={isSubmitting}>
        {isSubmitting ? 'Entrando...' : 'Entrar'}
      </Button>
    </form>
  )
}
```

### PadrÃµes de CÃ³digo
[Source: architecture/task-manager-architecture.md#17-coding-standards]

- Server Components por padrÃ£o â€” `'use client'` apenas em componentes de form e hooks
- Schemas Zod em `src/lib/schemas/` â€” nunca inline nos componentes
- Tipos em `src/types/` ou `auth.contract.ts` â€” nunca duplicar interfaces
- RepositÃ³rios/hooks nÃ£o acessam Supabase diretamente nos componentes
- Erros do Supabase SEMPRE mapeados para PT-BR antes de exibir ao usuÃ¡rio

### Testing

**UnitÃ¡rios (`npm run test`):**
- `src/lib/schemas/auth.schema.test.ts` â€” valid/invalid para loginSchema e signupSchema
- Testar casos: email invÃ¡lido, senha curta, senhas diferentes

**E2E (`npm run test:e2e`):**
- `e2e/auth.spec.ts` â€” fluxos completos com `page.goto`, `fill`, `click`, `expect`
- Usar email dinÃ¢mico para signup: `\`test+\${Date.now()}@example.com\``
- ATENÃ‡ÃƒO: Testes E2E de signup criam usuÃ¡rios reais no Supabase Cloud â€” usar domÃ­nio `@example.com` ou limpar depois

### VariÃ¡veis de Ambiente

JÃ¡ configuradas no `.env.local` (Story 1.2):
```
NEXT_PUBLIC_SUPABASE_URL=https://ejqvbradyzvaerzwkjmv.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_4qBss9sKNHpo8gCcDztkHw_xowNXogj
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |
| 2026-02-21 | 1.1 | Status Draft â†’ Ready â€” GO (10/10, Confidence: High). Should-note: ACs sem formato Given/When/Then (nÃ£o bloqueante); E2E cria usuÃ¡rios reais no Supabase â€” usar @example.com | @po (Pax) |

---

## Dev Agent Record

### Agent Model Used

_a preencher pelo @dev_

### Debug Log References

_a preencher pelo @dev_

### Completion Notes List

_a preencher pelo @dev_

### File List

_a preencher pelo @dev_
