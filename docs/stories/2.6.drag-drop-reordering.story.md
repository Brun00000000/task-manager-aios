# Story 2.6: Drag & Drop Reordering

## Status
Draft

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — dnd-kit + Position Persistence + Touch Support
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** reordenar minhas tarefas arrastando-as,
**so that** eu possa organizar visualmente minha lista de prioridades.

---

## Acceptance Criteria

1. Tarefas na lista `/tasks` sao reordenaveis via drag & drop usando `@dnd-kit/core`
2. Handle de drag exibido ao hover em cada item (icone de 6 pontos)
3. Feedback visual durante drag: item arrastado com sombra, posicao destino com placeholder
4. Ordem persistida no banco via coluna `position` (PATCH API Route)
5. Reordenacao funciona em touch/mobile (drag touch events)
6. Ordem preservada ao aplicar filtros (filtros nao resetam a ordem manual)
7. Performance: lista de ate 100 itens sem lag perceptivel durante drag

---

## Scope

**IN:**
- `src/app/api/tasks/reorder/route.ts` — PATCH: bulk update de positions
- `src/lib/repositories/TaskRepository.ts` — adicionar metodo `reorder(userId, items[])`
- `src/features/tasks/hooks/useReorderTasks.ts` — useMutation PATCH /api/tasks/reorder com optimistic update
- `src/features/tasks/components/SortableTaskList.tsx` — wrapper DndContext + SortableContext
- `src/features/tasks/components/SortableTaskCard.tsx` — TaskCard com useSortable do @dnd-kit
- Instalar `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities`
- Atualizar `src/app/(dashboard)/tasks/page.tsx` para usar SortableTaskList
- Configurar sensores touch e pointer no DndContext

**OUT:**
- Drag & drop entre listas diferentes (kanban)
- Drag & drop em mobile nativo app (apenas web)
- Reordenacao de categorias
- Undo de reordenacao

---

## Dependencies

- **Story 2.1** — TaskList, TaskCard, useTasks existem e serao substituidos por versoes sortable
- **Story 2.5** — filtros existem; a ordem manual deve ser preservada quando filtros sao aplicados
- **Coluna `position`** na tabela tasks (Story 1.2 — ja existe no schema)

---

## Complexity

**Estimativa:** 3 story points (S)

---

## Business Value

Drag & drop e feature diferencial confirmada no MVP. Usuarios que gerenciam listas manualmente se beneficiam enormemente da ordenacao visual flexivel.

---

## Risks

- **@dnd-kit e SSR:** Componentes dnd-kit sao Client Components — envolver em 'use client'.
- **Optimistic update na reordenacao:** Atualizar array local imediatamente antes do PATCH — importante para UX fluida.
- **Ordem com filtros:** Ao filtrar, exibir subconjunto na ordem correta de `position` — a query ja ordena por position ASC.
- **Touch events:** @dnd-kit/sortable suporta touch nativamente com TouchSensor — configurar junto com PointerSensor.
- **Bulk update de positions:** Enviar array [{id, position}] no PATCH — usar transacao no banco para atomicidade.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente
- [ ] `npm run lint && npm run typecheck && npm run test` passando
- [ ] Drag funciona em desktop (mouse) e mobile (touch)
- [ ] Posicao persistida ao recarregar pagina
- [ ] Lista de 50+ itens sem lag durante drag
- [ ] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [ ] **Task 1: Instalar dependencias dnd-kit** (AC: 1)
  - [ ] 1.1 `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

- [ ] **Task 2: Reorder no TaskRepository** (AC: 4)
  - [ ] 2.1 Adicionar metodo `reorder(userId, items: {id: string, position: number}[])` ao TaskRepository
  - [ ] 2.2 Implementar bulk UPDATE: UPDATE tasks SET position = $2 WHERE id = $1 AND user_id = $3
  - [ ] 2.3 Usar Promise.all para updates paralelos (ou upsert em batch via Supabase)

- [ ] **Task 3: API Route reorder** (AC: 4)
  - [ ] 3.1 Criar `src/app/api/tasks/reorder/route.ts`
  - [ ] 3.2 PATCH: receber `{ items: [{id, position}] }`, validar com Zod, chamar TaskRepository.reorder()
  - [ ] 3.3 Retornar 204 (No Content) em sucesso

- [ ] **Task 4: useReorderTasks hook** (AC: 4)
  - [ ] 4.1 Criar `src/features/tasks/hooks/useReorderTasks.ts`
  - [ ] 4.2 useMutation PATCH /api/tasks/reorder
  - [ ] 4.3 onMutate: optimistic update da queryData de tasks
  - [ ] 4.4 onError: rollback para estado anterior

- [ ] **Task 5: SortableTaskCard** (AC: 2, 3, 5)
  - [ ] 5.1 Criar `SortableTaskCard.tsx` como Client Component
  - [ ] 5.2 Usar `useSortable({ id: task.id })` do @dnd-kit/sortable
  - [ ] 5.3 DragHandle: icone GripVertical do Lucide, visivel no hover
  - [ ] 5.4 Aplicar `transform` e `transition` do useSortable para animacao
  - [ ] 5.5 Estilo durante drag: `opacity-50 shadow-lg ring-2 ring-blue-500`
  - [ ] 5.6 Reutilizar TaskCard internamente (composicao)

- [ ] **Task 6: SortableTaskList** (AC: 1, 3, 7)
  - [ ] 6.1 Criar `SortableTaskList.tsx` como Client Component
  - [ ] 6.2 DndContext com sensores: PointerSensor + TouchSensor (estrategia distance: 8px para evitar conflito com click)
  - [ ] 6.3 SortableContext com items=[task.id] e strategy=verticalListSortingStrategy
  - [ ] 6.4 onDragEnd: usar arrayMove do @dnd-kit/sortable para reordenar array local
  - [ ] 6.5 Apos arrayMove: calcular novos positions (index * 1000 para deixar espaco) e chamar useReorderTasks
  - [ ] 6.6 DragOverlay: renderizar TaskCard "fantasma" durante drag (feedback visual)

- [ ] **Task 7: Atualizar pagina /tasks** (AC: 1-7)
  - [ ] 7.1 Substituir TaskList por SortableTaskList em `src/app/(dashboard)/tasks/page.tsx`
  - [ ] 7.2 Garantir que filtros (Story 2.5) continuam funcionando com SortableTaskList
  - [ ] 7.3 Query de tasks ordenada por `position ASC` (ja deve estar no TaskRepository)

- [ ] **Task 8: Verificacao final** (AC: 1-7)
  - [ ] 8.1 `npm run lint && npm run typecheck && npm run test` passando
  - [ ] 8.2 Build limpo
  - [ ] 8.3 Testar em mobile: drag touch funciona sem disparar scroll
  - [ ] 8.4 File List completo abaixo

---

## Dev Notes

### dnd-kit Setup Basico

```tsx
'use client'
import {
  DndContext, closestCenter, PointerSensor, TouchSensor,
  useSensor, useSensors, DragOverlay,
} from '@dnd-kit/core'
import {
  SortableContext, verticalListSortingStrategy, arrayMove, useSortable,
} from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'

// Sensor config: distance 8px evita conflito com clicks
const sensors = useSensors(
  useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),
  useSensor(TouchSensor, { activationConstraint: { delay: 250, tolerance: 5 } }),
)

function onDragEnd(event) {
  const { active, over } = event
  if (!over || active.id === over.id) return
  const oldIndex = tasks.findIndex(t => t.id === active.id)
  const newIndex = tasks.findIndex(t => t.id === over.id)
  const reordered = arrayMove(tasks, oldIndex, newIndex)
  // optimistic update local + mutation
  setTasks(reordered)
  reorderTasks(reordered.map((t, i) => ({ id: t.id, position: (i + 1) * 1000 })))
}
```

### SortableTaskCard

```tsx
export function SortableTaskCard({ task }) {
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: task.id })
  return (
    <div
      ref={setNodeRef}
      style={{ transform: CSS.Transform.toString(transform), transition }}
      className={isDragging ? 'opacity-50' : ''}
    >
      {/* DragHandle */}
      <button {...attributes} {...listeners} className="cursor-grab p-1">
        <GripVertical className="h-4 w-4 text-gray-400" />
      </button>
      <TaskCard task={task} />
    </div>
  )
}
```

### Calculo de Position

```typescript
// Usar multiplos de 1000 para deixar espaco para insercoes futuras
const items = reordered.map((task, index) => ({
  id: task.id,
  position: (index + 1) * 1000,
}))
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |

---

## File List

**A criar:**
- src/app/api/tasks/reorder/route.ts
- src/features/tasks/hooks/useReorderTasks.ts
- src/features/tasks/components/SortableTaskCard.tsx
- src/features/tasks/components/SortableTaskList.tsx

**A modificar:**
- src/lib/repositories/TaskRepository.ts — reorder method
- src/app/(dashboard)/tasks/page.tsx — usar SortableTaskList
- docs/stories/2.6.drag-drop-reordering.story.md
