# Story 2.1: Task List & Create

## Status
Draft

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — API Routes + React Query + Task List + Create Drawer
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario autenticado,
**I want** ver minha lista de tarefas e criar novas tarefas rapidamente,
**so that** eu possa comecar a organizar meu trabalho imediatamente.

---

## Acceptance Criteria

1. Pagina `/tasks` exibe lista paginada das tarefas do usuario (20 por pagina)
2. Cada item da lista exibe: titulo, prioridade (badge colorido), prazo, status e categoria(s)
3. Estado vazio exibe ilustracao e botao "Criar primeira tarefa"
4. Botao "Nova Tarefa" abre formulario lateral (drawer) com campos: titulo (obrigatorio), descricao, prazo, prioridade (select), categoria(s) (multi-select)
5. Validacao Zod no frontend e na API Route — titulo minimo 3 caracteres
6. Tarefa criada aparece no topo da lista sem reload de pagina (React Query invalidation)
7. Tarefas atrasadas (prazo passado + status nao concluido) exibem indicador visual vermelho
8. Loading skeleton durante carregamento inicial da lista

---

## Scope

**IN:**
- `src/app/api/tasks/route.ts` — GET (lista paginada com filtros) + POST (criar tarefa)
- `src/lib/repositories/TaskRepository.ts` — acesso a dados (list, create)
- `src/features/tasks/schemas/task.schema.ts` — Zod schemas (taskCreateSchema, taskQuerySchema)
- `src/features/tasks/hooks/useTasks.ts` — React Query: useQuery para lista
- `src/features/tasks/hooks/useCreateTask.ts` — React Query: useMutation para criar
- `src/features/tasks/components/TaskList.tsx` — lista principal com paginacao
- `src/features/tasks/components/TaskCard.tsx` — item da lista (titulo, badge prioridade, prazo, status, categorias)
- `src/features/tasks/components/TaskDrawer.tsx` — drawer lateral para criacao (Sheet shadcn)
- `src/features/tasks/components/EmptyState.tsx` — estado vazio com CTA
- `src/features/tasks/components/TaskSkeleton.tsx` — loading skeleton
- `src/app/(dashboard)/tasks/page.tsx` — pagina /tasks usando AppShell existente
- Instalar dependencias: `@tanstack/react-query`, `@tanstack/react-query-devtools`, `date-fns`
- Configurar QueryClientProvider em `src/app/providers.tsx`
- Badges de prioridade: low=cinza, medium=azul, high=laranja, urgent=vermelho

**OUT:**
- Edicao e exclusao de tarefas (Story 2.2)
- Filtros e busca (Story 2.5)
- Drag & drop (Story 2.6)
- Categorias (Story 2.3) — multi-select no drawer usa categorias existentes mas nao as cria

---

## Dependencies

- **Story 1.4** — AppShell, layout, navegacao prontos; rotas /tasks protegidas pelo middleware
- **Story 1.2** — Schema do banco (tabelas tasks, categories, task_categories); RLS ativo
- **Story 1.3** — useAuthStore disponivel para user_id
- **`src/lib/supabase/server.ts`** — cliente server-side para API Routes
- **`src/types/database.types.ts`** — tipos gerados do Supabase
- **shadcn Sheet** — instalar se nao existir: `npx shadcn@latest add sheet`
- **shadcn Badge, Select, Textarea** — instalar se necessario

---

## Complexity

**Estimativa:** 5 story points (M)

---

## Business Value

Nucleo do produto. Sem esta story nao existe produto utilizavel. Estabelece o padrao de Repository + React Query que todas as stories seguintes reutilizarao.

---

## Risks

- **React Query setup:** QueryClientProvider deve ser Client Component em layout ou providers.tsx separado — usar `src/app/providers.tsx` como wrapper.
- **RLS em API Routes:** API Route usa `createClient()` server-side — RLS garante isolamento automaticamente via JWT do cookie.
- **Paginacao vs infinite scroll:** Usar paginacao simples (page/limit) — infinite scroll e escopo fora.
- **date-fns nao instalado:** Verificar antes; adicionar se ausente.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente
- [ ] `npm run lint && npm run typecheck && npm run test` passando
- [ ] API Route GET /api/tasks retorna lista paginada corretamente
- [ ] API Route POST /api/tasks valida com Zod e retorna 201
- [ ] Drawer abre/fecha, formulario valida, tarefa aparece na lista sem reload
- [ ] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> Revisao de qualidade via processo manual + CI pipeline (lint + typecheck + test).

---

## Tasks / Subtasks

- [ ] **Task 1: Setup React Query** (AC: 6, 8)
  - [ ] 1.1 Instalar `@tanstack/react-query` e `@tanstack/react-query-devtools`
  - [ ] 1.2 Criar `src/app/providers.tsx` com QueryClientProvider (Client Component)
  - [ ] 1.3 Envolver layout raiz com Providers em `src/app/layout.tsx`

- [ ] **Task 2: Instalar dependencias adicionais** (AC: 7)
  - [ ] 2.1 Verificar/instalar `date-fns` para formatacao de datas
  - [ ] 2.2 Instalar shadcn Sheet: `npx shadcn@latest add sheet`
  - [ ] 2.3 Instalar shadcn Badge, Select, Textarea se ausentes

- [ ] **Task 3: Zod Schemas** (AC: 5)
  - [ ] 3.1 Criar `src/features/tasks/schemas/task.schema.ts`
  - [ ] 3.2 `taskCreateSchema`: title (min 3), description?, due_date?, priority, status, category_ids[]
  - [ ] 3.3 `taskQuerySchema`: page, limit, status?, priority?, category_id?, due?, search?

- [ ] **Task 4: TaskRepository** (AC: 1, 2)
  - [ ] 4.1 Criar `src/lib/repositories/TaskRepository.ts`
  - [ ] 4.2 Metodo `list(userId, query)`: SELECT com filtros, paginacao, JOIN categories
  - [ ] 4.3 Metodo `create(userId, data)`: INSERT + associar categorias em task_categories
  - [ ] 4.4 Filtrar `deleted_at IS NULL` em todas as queries de lista

- [ ] **Task 5: API Routes** (AC: 1, 5, 6)
  - [ ] 5.1 Criar `src/app/api/tasks/route.ts`
  - [ ] 5.2 GET: validar query params com taskQuerySchema, chamar TaskRepository.list()
  - [ ] 5.3 POST: validar body com taskCreateSchema, chamar TaskRepository.create(), retornar 201
  - [ ] 5.4 Autenticar via createClient() server-side (JWT do cookie)

- [ ] **Task 6: React Query Hooks** (AC: 6, 8)
  - [ ] 6.1 Criar `src/features/tasks/hooks/useTasks.ts` (useQuery GET /api/tasks)
  - [ ] 6.2 Criar `src/features/tasks/hooks/useCreateTask.ts` (useMutation POST + invalidateQueries)

- [ ] **Task 7: Componentes de UI** (AC: 2, 3, 7, 8)
  - [ ] 7.1 Criar `TaskCard.tsx` — titulo, badge prioridade (cores), prazo (date-fns), status, badges categoria
  - [ ] 7.2 Indicador vermelho para tarefas atrasadas (due_date < hoje && status != 'done')
  - [ ] 7.3 Criar `TaskSkeleton.tsx` — skeleton de loading (shadcn Skeleton)
  - [ ] 7.4 Criar `EmptyState.tsx` — ilustracao + botao "Criar primeira tarefa"
  - [ ] 7.5 Criar `TaskList.tsx` — renderiza lista, paginacao, estados loading/empty

- [ ] **Task 8: TaskDrawer (criacao)** (AC: 4, 5, 6)
  - [ ] 8.1 Criar `TaskDrawer.tsx` com Sheet shadcn
  - [ ] 8.2 Campos: titulo (Input), descricao (Textarea), prazo (Input type=date), prioridade (Select), categorias (multi-select basico)
  - [ ] 8.3 React Hook Form + zodResolver para validacao client-side
  - [ ] 8.4 Submit chama useCreateTask, fecha drawer em sucesso, lista atualiza automaticamente

- [ ] **Task 9: Pagina /tasks** (AC: 1, 3, 4)
  - [ ] 9.1 Criar `src/app/(dashboard)/tasks/page.tsx`
  - [ ] 9.2 Header da pagina com titulo "Tarefas" e botao "Nova Tarefa"
  - [ ] 9.3 Renderizar TaskList + TaskDrawer controlado por estado open/close

- [ ] **Task 10: Verificacao final** (AC: 1-8)
  - [ ] 10.1 `npm run lint && npm run typecheck && npm run test` passando
  - [ ] 10.2 Build de producao limpo
  - [ ] 10.3 File List completo abaixo

---

## Dev Notes

### Padrao de Repository

```typescript
// src/lib/repositories/TaskRepository.ts
export class TaskRepository {
  constructor(private supabase: SupabaseClient) {}

  async list(userId: string, query: TaskQuery): Promise<{ tasks: TaskSummary[]; total: number }> {
    // SELECT com RLS automatico
  }

  async create(userId: string, data: TaskCreate): Promise<Task> {
    // INSERT + task_categories
  }
}
```

### React Query Pattern

```typescript
// useTasks.ts
export function useTasks(query: TaskQuery) {
  return useQuery({
    queryKey: ['tasks', query],
    queryFn: () => fetch(`/api/tasks?${qs}`).then(r => r.json()),
  })
}

// useCreateTask.ts
export function useCreateTask() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: (data: TaskCreate) => fetch('/api/tasks', { method: 'POST', body: JSON.stringify(data) }),
    onSuccess: () => qc.invalidateQueries({ queryKey: ['tasks'] }),
  })
}
```

### Cores de Prioridade

| Prioridade | Badge | Classe Tailwind |
|-----------|-------|-----------------|
| low | Cinza | `bg-gray-100 text-gray-600` |
| medium | Azul | `bg-blue-100 text-blue-700` |
| high | Laranja | `bg-orange-100 text-orange-700` |
| urgent | Vermelho | `bg-red-100 text-red-700` |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |

---

## File List

**A criar:**
- src/app/providers.tsx
- src/features/tasks/schemas/task.schema.ts
- src/lib/repositories/TaskRepository.ts
- src/app/api/tasks/route.ts
- src/features/tasks/hooks/useTasks.ts
- src/features/tasks/hooks/useCreateTask.ts
- src/features/tasks/components/TaskCard.tsx
- src/features/tasks/components/TaskList.tsx
- src/features/tasks/components/TaskDrawer.tsx
- src/features/tasks/components/TaskSkeleton.tsx
- src/features/tasks/components/EmptyState.tsx
- src/app/(dashboard)/tasks/page.tsx

**A modificar:**
- src/app/layout.tsx — adicionar Providers wrapper
- docs/stories/2.1.task-list-create.story.md
