# Story 2.4: Dashboard Overview

## Status
Draft

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — Dashboard Stats API + Cards + Chart + Lists
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** um dashboard com visao geral das minhas tarefas,
**so that** eu possa avaliar minha produtividade e prioridades rapidamente.

---

## Acceptance Criteria

1. Pagina `/dashboard` exibe 4 cards de metricas: Total, A fazer, Em progresso, Concluidas
2. Card adicional "Atrasadas" com destaque em vermelho (prazo passado + nao concluidas)
3. Lista "Vencendo hoje" exibe tarefas com prazo no dia atual
4. Lista "Proximas" exibe as 5 tarefas com prazo mais proximo
5. Grafico de barras simples mostrando tarefas concluidas nos ultimos 7 dias
6. Dados do dashboard atualizados via React Query (refetch a cada 60s)
7. Estado vazio do dashboard encoraja criacao da primeira tarefa com CTA

---

## Scope

**IN:**
- `src/app/api/dashboard/stats/route.ts` — GET: metricas agregadas (DashboardStats)
- `src/lib/repositories/TaskRepository.ts` — adicionar metodo `getDashboardStats(userId)`
- `src/features/dashboard/hooks/useDashboardStats.ts` — useQuery com refetchInterval 60s
- `src/features/dashboard/components/StatsCard.tsx` — card individual de metrica
- `src/features/dashboard/components/ActivityChart.tsx` — grafico de barras 7 dias (recharts)
- `src/features/dashboard/components/UpcomingList.tsx` — lista "Proximas" e "Vencendo hoje"
- `src/features/dashboard/components/DashboardEmpty.tsx` — estado vazio com CTA
- `src/app/(dashboard)/dashboard/page.tsx` — substitui o placeholder existente
- Instalar `recharts` para o grafico de barras

**OUT:**
- Graficos de pizza ou linha
- Metricas de produtividade avancadas
- Filtros no dashboard
- Comparativo com periodo anterior
- Dashboard de workspace (Epic 3)

---

## Dependencies

- **Story 2.1** — TaskRepository base existe; padrao React Query estabelecido
- **Story 2.3** — categorias existem (podem ser exibidas no dashboard futuramente)
- **`recharts`** — instalar: `npm install recharts`

---

## Complexity

**Estimativa:** 3 story points (S)

---

## Business Value

Dashboard e a tela de entrada da aplicacao — primeira impressao do produto. Metricas visuais aumentam engajamento e motivam o usuario a usar o sistema diariamente.

---

## Risks

- **Query agregada complexa:** getDashboardStats faz multiplas queries ou uma query SQL com agregacoes — usar queries separadas e Promise.all para paralelismo.
- **recharts e SSR:** Recharts usa APIs do browser — componente deve ser Client Component ou usar dynamic import com ssr: false.
- **Calculo de "atrasadas":** due_date < CURRENT_DATE AND status != 'done' — garantir timezone correto (usar UTC no banco).
- **Refetch interval:** 60s e agressivo para produção — OK para MVP.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente
- [ ] `npm run lint && npm run typecheck && npm run test` passando
- [ ] API /api/dashboard/stats retorna DashboardStats corretamente
- [ ] Grafico renderiza sem erros no cliente
- [ ] Refetch automatico a cada 60s funcionando (verificar no Network tab)
- [ ] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [ ] **Task 1: Instalar recharts** (AC: 5)
  - [ ] 1.1 `npm install recharts`

- [ ] **Task 2: getDashboardStats no TaskRepository** (AC: 1, 2, 3, 4, 5)
  - [ ] 2.1 Query contagens: total, todo, in_progress, done (WHERE deleted_at IS NULL)
  - [ ] 2.2 Query overdue: due_date < hoje AND status != 'done' AND deleted_at IS NULL
  - [ ] 2.3 Query due_today: due_date = hoje AND status != 'done' AND deleted_at IS NULL (retornar TaskSummary[])
  - [ ] 2.4 Query upcoming: proximas 5 tarefas por due_date ASC (retornar TaskSummary[])
  - [ ] 2.5 Query activity: COUNT de tarefas concluidas por dia nos ultimos 7 dias

- [ ] **Task 3: API Route** (AC: 1-5)
  - [ ] 3.1 Criar `src/app/api/dashboard/stats/route.ts`
  - [ ] 3.2 GET: autenticar, chamar getDashboardStats, retornar DashboardStats
  - [ ] 3.3 Retornar estado vazio (zeros) se usuario nao tem tarefas

- [ ] **Task 4: useDashboardStats hook** (AC: 6)
  - [ ] 4.1 Criar `src/features/dashboard/hooks/useDashboardStats.ts`
  - [ ] 4.2 useQuery com queryKey: ['dashboard', 'stats']
  - [ ] 4.3 refetchInterval: 60 * 1000 (60 segundos)

- [ ] **Task 5: StatsCard** (AC: 1, 2, 7)
  - [ ] 5.1 Criar `StatsCard.tsx` — props: title, value, icon, variant (default/red)
  - [ ] 5.2 Card "Atrasadas": variant red (borda e texto vermelhos)
  - [ ] 5.3 Estado vazio: todos os cards com valor 0 + CTA "Criar primeira tarefa"

- [ ] **Task 6: ActivityChart** (AC: 5)
  - [ ] 6.1 Criar `ActivityChart.tsx` como Client Component
  - [ ] 6.2 BarChart do recharts: eixo X = dia da semana, eixo Y = tarefas concluidas
  - [ ] 6.3 Usar dynamic import (next/dynamic ssr:false) se necessario para evitar SSR issues

- [ ] **Task 7: UpcomingList** (AC: 3, 4)
  - [ ] 7.1 Criar `UpcomingList.tsx` — duas secoes: "Vencendo hoje" e "Proximas"
  - [ ] 7.2 Cada item: titulo + prazo formatado (date-fns) + badge prioridade
  - [ ] 7.3 Link para /tasks ao clicar em cada item

- [ ] **Task 8: DashboardEmpty** (AC: 7)
  - [ ] 8.1 Criar `DashboardEmpty.tsx` — mensagem + botao "Criar sua primeira tarefa" (link /tasks)
  - [ ] 8.2 Exibir quando total === 0

- [ ] **Task 9: Pagina /dashboard** (AC: 1-7)
  - [ ] 9.1 Atualizar `src/app/(dashboard)/dashboard/page.tsx` (substituir placeholder)
  - [ ] 9.2 Layout: grid de 5 StatsCards + ActivityChart + UpcomingList
  - [ ] 9.3 Loading skeleton durante fetch inicial

- [ ] **Task 10: Verificacao final** (AC: 1-7)
  - [ ] 10.1 `npm run lint && npm run typecheck && npm run test` passando
  - [ ] 10.2 Build limpo
  - [ ] 10.3 File List completo abaixo

---

## Dev Notes

### DashboardStats Interface (da arquitetura)

```typescript
export interface DashboardStats {
  total: number;
  todo: number;
  in_progress: number;
  done: number;
  overdue: number;
  due_today: TaskSummary[];
  upcoming: TaskSummary[];
  activity: { date: string; completed: number }[];
}
```

### recharts BarChart basico

```tsx
'use client'
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts'

export function ActivityChart({ data }: { data: { date: string; completed: number }[] }) {
  return (
    <ResponsiveContainer width="100%" height={200}>
      <BarChart data={data}>
        <XAxis dataKey="date" />
        <YAxis />
        <Tooltip />
        <Bar dataKey="completed" fill="#3b82f6" radius={[4, 4, 0, 0]} />
      </BarChart>
    </ResponsiveContainer>
  )
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |

---

## File List

**A criar:**
- src/app/api/dashboard/stats/route.ts
- src/features/dashboard/hooks/useDashboardStats.ts
- src/features/dashboard/components/StatsCard.tsx
- src/features/dashboard/components/ActivityChart.tsx
- src/features/dashboard/components/UpcomingList.tsx
- src/features/dashboard/components/DashboardEmpty.tsx

**A modificar:**
- src/app/(dashboard)/dashboard/page.tsx — substituir placeholder
- src/lib/repositories/TaskRepository.ts — getDashboardStats
- docs/stories/2.4.dashboard-overview.story.md
