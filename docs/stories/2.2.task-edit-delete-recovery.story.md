# Story 2.2: Task Edit, Delete & Recovery

## Status
Done

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — Edit Inline + Drawer + Soft Delete + Undo Toast + Trash Page
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** editar, excluir e recuperar tarefas,
**so that** eu mantenha minha lista sempre precisa e nao perca dados por engano.

---

## Acceptance Criteria

1. Clique no titulo da tarefa na lista abre edicao inline do titulo (sem modal)
2. Clique em qualquer outro campo abre drawer de edicao completa com todos os campos
3. Alteracoes salvas otimisticamente no cliente (UI atualiza imediatamente, reverte em erro)
4. Botao de excluir (soft delete) pede confirmacao com mensagem "Tarefa movida para a lixeira"
5. Toast de confirmacao apos exclusao exibe botao "Desfazer" por 5 segundos
6. Tarefas excluidas sao filtradas da lista principal automaticamente via RLS
7. Pagina `/tasks/trash` lista tarefas excluidas nos ultimos 30 dias com opcao de recuperar
8. Status da tarefa alteravel via dropdown direto na lista (sem abrir drawer)

---

## Scope

**IN:**
- `src/app/api/tasks/[id]/route.ts` — GET, PATCH, DELETE (soft delete: set deleted_at)
- `src/app/api/tasks/[id]/restore/route.ts` — POST (restaurar: set deleted_at = null)
- `src/app/api/tasks/trash/route.ts` — GET (tarefas com deleted_at NOT NULL, < 30 dias)
- `src/lib/repositories/TaskRepository.ts` — adicionar: update, softDelete, restore, listTrash
- `src/features/tasks/schemas/task.schema.ts` — adicionar taskUpdateSchema
- `src/features/tasks/hooks/useUpdateTask.ts` — useMutation PATCH com optimistic update
- `src/features/tasks/hooks/useDeleteTask.ts` — useMutation DELETE + undo logic
- `src/features/tasks/hooks/useRestoreTask.ts` — useMutation POST restore
- `src/features/tasks/components/TaskCard.tsx` — adicionar: inline title edit, status dropdown, delete button
- `src/features/tasks/components/TaskDrawer.tsx` — estender para modo edicao (pre-populate campos)
- `src/features/tasks/components/TrashList.tsx` — lista de tarefas na lixeira
- `src/app/(dashboard)/tasks/trash/page.tsx` — pagina /tasks/trash
- Instalar `sonner` para toast notifications

**OUT:**
- Exclusao permanente (purge) — apenas soft delete
- Expiracao automatica de 30 dias — nao implementar cron job (fora do MVP)
- Historico de alteracoes

---

## Dependencies

- **Story 2.1** — TaskRepository base, useTasks, TaskCard, TaskDrawer, TaskList todos existem
- **`sonner`** — instalar: `npm install sonner`; configurar Toaster no providers.tsx

---

## Complexity

**Estimativa:** 5 story points (M)

---

## Business Value

Sem edicao e exclusao segura o produto e inutilizavel em uso real. O undo toast e diferencial de UX que previne perda acidental de dados.

---

## Risks

- **Optimistic update com rollback:** useMutation onMutate/onError do React Query — implementar corretamente para nao deixar UI em estado inconsistente.
- **Undo window de 5s:** usar setTimeout com cleanup (clearTimeout) — cuidar com re-renders.
- **RLS para trash:** deleted_at IS NOT NULL requer politica RLS adicional ou query explica; usar service role na API Route.
- **Inline edit no titulo:** usar estado local + onBlur para salvar — nao usar form completo.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente
- [ ] `npm run lint && npm run typecheck && npm run test` passando
- [ ] Optimistic update funciona: UI atualiza imediato, reverte em erro simulado
- [ ] Toast "Desfazer" funciona: tarefa restaurada ao clicar em 5s
- [ ] Pagina /tasks/trash lista e restaura corretamente
- [ ] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [x] **Task 1: Instalar sonner** (AC: 5)
  - [x] 1.1 `npm install sonner` — já instalado na Story 2.1
  - [x] 1.2 Adicionar `<Toaster />` ao providers.tsx — já feito na Story 2.1

- [x] **Task 2: Estender TaskRepository** (AC: 3, 4, 6, 7)
  - [x] 2.1 Metodo `update(userId, id, data)`: UPDATE com verificacao de ownership via RLS
  - [x] 2.2 Metodo `softDelete(userId, id)`: SET deleted_at = now()
  - [x] 2.3 Metodo `restore(userId, id)`: SET deleted_at = null
  - [x] 2.4 Metodo `listTrash(userId)`: WHERE deleted_at IS NOT NULL AND deleted_at > now() - 30 days

- [x] **Task 3: API Routes** (AC: 2, 3, 4, 7)
  - [x] 3.1 Criar `src/app/api/tasks/[id]/route.ts` — GET, PATCH (update), DELETE (soft delete)
  - [x] 3.2 Criar `src/app/api/tasks/[id]/restore/route.ts` — POST (restore)
  - [x] 3.3 Criar `src/app/api/tasks/trash/route.ts` — GET (lista lixeira)
  - [x] 3.4 Validar body do PATCH com taskUpdateSchema (Zod)

- [x] **Task 4: React Query Hooks** (AC: 3, 4, 5)
  - [x] 4.1 Criar `useUpdateTask.ts` com optimistic update (onMutate/onError/onSettled)
  - [x] 4.2 Criar `useDeleteTask.ts` — soft delete + undo logic com sonner toast
  - [x] 4.3 Criar `useRestoreTask.ts` — POST restore + invalidateQueries

- [x] **Task 5: Inline title edit no TaskCard** (AC: 1, 8)
  - [x] 5.1 Clique no titulo: mostra Input inline com valor atual
  - [x] 5.2 onBlur ou Enter: salva via useUpdateTask se titulo mudou
  - [x] 5.3 Escape: cancela edicao sem salvar
  - [x] 5.4 Status dropdown direto na lista: Select com opcoes todo/in_progress/done

- [x] **Task 6: TaskDrawer em modo edicao** (AC: 2, 3)
  - [x] 6.1 Aceitar prop `task?: TaskSummary` para pre-popular campos
  - [x] 6.2 Se task passada: modo edicao (titulo "Editar Tarefa", submit chama useUpdateTask)
  - [x] 6.3 Clique no card (fora do titulo) abre drawer com task pre-populada

- [x] **Task 7: Delete com confirmacao e undo** (AC: 4, 5, 6)
  - [x] 7.1 Botao excluir no TaskCard (icone trash, aparece no hover)
  - [x] 7.2 Clique: soft delete imediato via useDeleteTask (optimistic)
  - [x] 7.3 Toast sonner: "Tarefa movida para a lixeira" + botao "Desfazer" (5s)
  - [x] 7.4 Clique em "Desfazer": chamar useRestoreTask
  - [x] 7.5 Apos 5s sem acao: soft delete confirmado

- [x] **Task 8: Pagina /tasks/trash** (AC: 7)
  - [x] 8.1 Criar `src/features/tasks/components/TrashList.tsx`
  - [x] 8.2 Exibir tarefas com data de exclusao e botao "Restaurar"
  - [x] 8.3 Criar `src/app/(dashboard)/tasks/trash/page.tsx`
  - [x] 8.4 Link "Lixeira" na pagina /tasks

- [x] **Task 9: Verificacao final** (AC: 1-8)
  - [x] 9.1 lint ✅ (0 erros) | typecheck ✅ | test 8/8 ✅
  - [x] 9.2 Build limpo — 13 routes
  - [x] 9.3 File List completo abaixo

---

## Dev Notes

### Optimistic Update Pattern

```typescript
export function useUpdateTask() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ id, data }) => fetch(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify(data) }),
    onMutate: async ({ id, data }) => {
      await qc.cancelQueries({ queryKey: ['tasks'] })
      const previous = qc.getQueryData(['tasks'])
      qc.setQueryData(['tasks'], (old) => /* aplica update otimista */)
      return { previous }
    },
    onError: (_, __, ctx) => qc.setQueryData(['tasks'], ctx.previous),
    onSettled: () => qc.invalidateQueries({ queryKey: ['tasks'] }),
  })
}
```

### Undo Toast com sonner

```typescript
const { mutate: deleteTask } = useDeleteTask()
const { mutate: restoreTask } = useRestoreTask()

toast('Tarefa movida para a lixeira', {
  duration: 5000,
  action: {
    label: 'Desfazer',
    onClick: () => restoreTask(taskId),
  },
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |
| 2026-02-21 | 1.1 | Status Draft para Ready — GO (10/10). Optimistic update e undo toast bem especificados, riscos de rollback documentados. Pronta para implementação. | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa (YOLO mode). Todos os 8 ACs implementados. lint ✅ | typecheck ✅ | test 8/8 ✅ | build ✅. Status → InReview. | @dev (Dex) |
| 2026-02-21 | 1.3 | PR #8 merged (squash) → develop. CI Quality Checks ✅ (43s). Status → Done. | @devops (Gage) |

---

## File List

**Criados:**
- src/app/api/tasks/[id]/route.ts — GET, PATCH (update), DELETE (soft delete)
- src/app/api/tasks/[id]/restore/route.ts — POST (restaurar tarefa)
- src/app/api/tasks/trash/route.ts — GET (lixeira, últimos 30 dias)
- src/features/tasks/hooks/useUpdateTask.ts — optimistic update (onMutate/onError/onSettled)
- src/features/tasks/hooks/useDeleteTask.ts — soft delete + snapshot rollback
- src/features/tasks/hooks/useRestoreTask.ts — restore + invalidateQueries
- src/features/tasks/components/TrashList.tsx — lista lixeira com botão Restaurar
- src/app/(dashboard)/tasks/trash/page.tsx — página /tasks/trash

**Modificados:**
- src/lib/repositories/TaskRepository.ts — update(), softDelete(), restore(), listTrash()
- src/features/tasks/components/TaskCard.tsx — inline title edit, status Select, delete button (hover)
- src/features/tasks/components/TaskDrawer.tsx — modo edição com pre-populate via useEffect
- src/features/tasks/components/TaskList.tsx — prop onEditTask adicionada
- src/app/(dashboard)/tasks/page.tsx — estado editingTask, link Lixeira
- docs/stories/2.2.task-edit-delete-recovery.story.md
