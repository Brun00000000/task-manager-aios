# Story 2.2: Task Edit, Delete & Recovery

## Status
Draft

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — Edit Inline + Drawer + Soft Delete + Undo Toast + Trash Page
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** editar, excluir e recuperar tarefas,
**so that** eu mantenha minha lista sempre precisa e nao perca dados por engano.

---

## Acceptance Criteria

1. Clique no titulo da tarefa na lista abre edicao inline do titulo (sem modal)
2. Clique em qualquer outro campo abre drawer de edicao completa com todos os campos
3. Alteracoes salvas otimisticamente no cliente (UI atualiza imediatamente, reverte em erro)
4. Botao de excluir (soft delete) pede confirmacao com mensagem "Tarefa movida para a lixeira"
5. Toast de confirmacao apos exclusao exibe botao "Desfazer" por 5 segundos
6. Tarefas excluidas sao filtradas da lista principal automaticamente via RLS
7. Pagina `/tasks/trash` lista tarefas excluidas nos ultimos 30 dias com opcao de recuperar
8. Status da tarefa alteravel via dropdown direto na lista (sem abrir drawer)

---

## Scope

**IN:**
- `src/app/api/tasks/[id]/route.ts` — GET, PATCH, DELETE (soft delete: set deleted_at)
- `src/app/api/tasks/[id]/restore/route.ts` — POST (restaurar: set deleted_at = null)
- `src/app/api/tasks/trash/route.ts` — GET (tarefas com deleted_at NOT NULL, < 30 dias)
- `src/lib/repositories/TaskRepository.ts` — adicionar: update, softDelete, restore, listTrash
- `src/features/tasks/schemas/task.schema.ts` — adicionar taskUpdateSchema
- `src/features/tasks/hooks/useUpdateTask.ts` — useMutation PATCH com optimistic update
- `src/features/tasks/hooks/useDeleteTask.ts` — useMutation DELETE + undo logic
- `src/features/tasks/hooks/useRestoreTask.ts` — useMutation POST restore
- `src/features/tasks/components/TaskCard.tsx` — adicionar: inline title edit, status dropdown, delete button
- `src/features/tasks/components/TaskDrawer.tsx` — estender para modo edicao (pre-populate campos)
- `src/features/tasks/components/TrashList.tsx` — lista de tarefas na lixeira
- `src/app/(dashboard)/tasks/trash/page.tsx` — pagina /tasks/trash
- Instalar `sonner` para toast notifications

**OUT:**
- Exclusao permanente (purge) — apenas soft delete
- Expiracao automatica de 30 dias — nao implementar cron job (fora do MVP)
- Historico de alteracoes

---

## Dependencies

- **Story 2.1** — TaskRepository base, useTasks, TaskCard, TaskDrawer, TaskList todos existem
- **`sonner`** — instalar: `npm install sonner`; configurar Toaster no providers.tsx

---

## Complexity

**Estimativa:** 5 story points (M)

---

## Business Value

Sem edicao e exclusao segura o produto e inutilizavel em uso real. O undo toast e diferencial de UX que previne perda acidental de dados.

---

## Risks

- **Optimistic update com rollback:** useMutation onMutate/onError do React Query — implementar corretamente para nao deixar UI em estado inconsistente.
- **Undo window de 5s:** usar setTimeout com cleanup (clearTimeout) — cuidar com re-renders.
- **RLS para trash:** deleted_at IS NOT NULL requer politica RLS adicional ou query explica; usar service role na API Route.
- **Inline edit no titulo:** usar estado local + onBlur para salvar — nao usar form completo.

---

## Definition of Done

- [ ] Todos os ACs verificados manualmente
- [ ] `npm run lint && npm run typecheck && npm run test` passando
- [ ] Optimistic update funciona: UI atualiza imediato, reverte em erro simulado
- [ ] Toast "Desfazer" funciona: tarefa restaurada ao clicar em 5s
- [ ] Pagina /tasks/trash lista e restaura corretamente
- [ ] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [ ] **Task 1: Instalar sonner** (AC: 5)
  - [ ] 1.1 `npm install sonner`
  - [ ] 1.2 Adicionar `<Toaster />` ao providers.tsx

- [ ] **Task 2: Estender TaskRepository** (AC: 3, 4, 6, 7)
  - [ ] 2.1 Metodo `update(userId, id, data)`: UPDATE com verificacao de ownership via RLS
  - [ ] 2.2 Metodo `softDelete(userId, id)`: SET deleted_at = now()
  - [ ] 2.3 Metodo `restore(userId, id)`: SET deleted_at = null
  - [ ] 2.4 Metodo `listTrash(userId)`: WHERE deleted_at IS NOT NULL AND deleted_at > now() - 30 days

- [ ] **Task 3: API Routes** (AC: 2, 3, 4, 7)
  - [ ] 3.1 Criar `src/app/api/tasks/[id]/route.ts` — PATCH (update), DELETE (soft delete)
  - [ ] 3.2 Criar `src/app/api/tasks/[id]/restore/route.ts` — POST (restore)
  - [ ] 3.3 Criar `src/app/api/tasks/trash/route.ts` — GET (lista lixeira)
  - [ ] 3.4 Validar body do PATCH com taskUpdateSchema (Zod)

- [ ] **Task 4: React Query Hooks** (AC: 3, 4, 5)
  - [ ] 4.1 Criar `useUpdateTask.ts` com optimistic update (onMutate/onError/onSettled)
  - [ ] 4.2 Criar `useDeleteTask.ts` — soft delete + undo logic com sonner toast
  - [ ] 4.3 Criar `useRestoreTask.ts` — POST restore + invalidateQueries

- [ ] **Task 5: Inline title edit no TaskCard** (AC: 1, 8)
  - [ ] 5.1 Clique no titulo: mostra Input inline com valor atual
  - [ ] 5.2 onBlur ou Enter: salva via useUpdateTask se titulo mudou
  - [ ] 5.3 Escape: cancela edicao sem salvar
  - [ ] 5.4 Status dropdown direto na lista: Select com opcoes todo/in_progress/done

- [ ] **Task 6: TaskDrawer em modo edicao** (AC: 2, 3)
  - [ ] 6.1 Aceitar prop `task?: Task` para pre-popular campos
  - [ ] 6.2 Se task passada: modo edicao (titulo do drawer "Editar Tarefa", submit chama useUpdateTask)
  - [ ] 6.3 Clique fora do titulo no TaskCard abre drawer com task pre-populada

- [ ] **Task 7: Delete com confirmacao e undo** (AC: 4, 5, 6)
  - [ ] 7.1 Botao excluir no TaskCard (icone trash, aparece no hover)
  - [ ] 7.2 Clique: chamar useDeleteTask diretamente (sem dialog de confirmacao separado — o toast de undo e o mecanismo de seguranca)
  - [ ] 7.3 Toast sonner: "Tarefa movida para a lixeira" + botao "Desfazer"
  - [ ] 7.4 Clique em "Desfazer": chamar useRestoreTask, dismiss toast
  - [ ] 7.5 Apos 5s sem acao: soft delete confirmado (deleted_at permanece)

- [ ] **Task 8: Pagina /tasks/trash** (AC: 7)
  - [ ] 8.1 Criar `src/features/tasks/components/TrashList.tsx`
  - [ ] 8.2 Exibir tarefas com data de exclusao e botao "Restaurar"
  - [ ] 8.3 Criar `src/app/(dashboard)/tasks/trash/page.tsx`
  - [ ] 8.4 Link para /tasks/trash na pagina /tasks (ex: "Ver lixeira")

- [ ] **Task 9: Verificacao final** (AC: 1-8)
  - [ ] 9.1 `npm run lint && npm run typecheck && npm run test` passando
  - [ ] 9.2 Build limpo
  - [ ] 9.3 File List completo abaixo

---

## Dev Notes

### Optimistic Update Pattern

```typescript
export function useUpdateTask() {
  const qc = useQueryClient()
  return useMutation({
    mutationFn: ({ id, data }) => fetch(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify(data) }),
    onMutate: async ({ id, data }) => {
      await qc.cancelQueries({ queryKey: ['tasks'] })
      const previous = qc.getQueryData(['tasks'])
      qc.setQueryData(['tasks'], (old) => /* aplica update otimista */)
      return { previous }
    },
    onError: (_, __, ctx) => qc.setQueryData(['tasks'], ctx.previous),
    onSettled: () => qc.invalidateQueries({ queryKey: ['tasks'] }),
  })
}
```

### Undo Toast com sonner

```typescript
const { mutate: deleteTask } = useDeleteTask()
const { mutate: restoreTask } = useRestoreTask()

toast('Tarefa movida para a lixeira', {
  duration: 5000,
  action: {
    label: 'Desfazer',
    onClick: () => restoreTask(taskId),
  },
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |

---

## File List

**A criar:**
- src/app/api/tasks/[id]/route.ts
- src/app/api/tasks/[id]/restore/route.ts
- src/app/api/tasks/trash/route.ts
- src/features/tasks/hooks/useUpdateTask.ts
- src/features/tasks/hooks/useDeleteTask.ts
- src/features/tasks/hooks/useRestoreTask.ts
- src/features/tasks/components/TrashList.tsx
- src/app/(dashboard)/tasks/trash/page.tsx

**A modificar:**
- src/lib/repositories/TaskRepository.ts — update, softDelete, restore, listTrash
- src/features/tasks/schemas/task.schema.ts — taskUpdateSchema
- src/features/tasks/components/TaskCard.tsx — inline edit, status dropdown, delete button
- src/features/tasks/components/TaskDrawer.tsx — modo edicao
- src/app/providers.tsx — Toaster do sonner
- docs/stories/2.2.task-edit-delete-recovery.story.md
