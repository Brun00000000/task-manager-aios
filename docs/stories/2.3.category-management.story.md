# Story 2.3: Category Management & Association

## Status
Done

## Executor Assignment

```yaml
executor: "@dev"
quality_gate: "@qa"
quality_gate_tools:
  - code-review
  - unit-tests
  - e2e-tests
```

> **Work Type:** Code/Features/UI — Category CRUD + Color Palette + Task Association
> **Supporting Agent:** nenhum — story autocontida

---

## Story

**As a** usuario,
**I want** criar categorias personalizadas e associa-las as minhas tarefas,
**so that** eu possa organizar tarefas por contexto ou projeto.

---

## Acceptance Criteria

1. Pagina `/categories` lista todas as categorias do usuario com contagem de tarefas associadas
2. CRUD completo de categorias: criar com nome + cor (palette de 12 cores), editar, excluir
3. Exclusao de categoria com tarefas associadas exibe aviso e opcao de reassociar ou manter sem categoria
4. Multi-select de categorias no formulario de criacao/edicao de tarefas (maximo 5 por tarefa)
5. Badges de categoria exibidos em cada tarefa na lista com a cor configurada
6. Filtro rapido na lista de tarefas por categoria (click no badge filtra a lista)

---

## Scope

**IN:**
- `src/app/api/categories/route.ts` — GET (lista com task_count) + POST (criar)
- `src/app/api/categories/[id]/route.ts` — PATCH (editar) + DELETE (com verificacao de tarefas)
- `src/lib/repositories/CategoryRepository.ts` — list (com task_count), create, update, delete
- `src/features/categories/schemas/category.schema.ts` — Zod: categoryCreateSchema, categoryUpdateSchema
- `src/features/categories/hooks/useCategories.ts` — useQuery GET /api/categories
- `src/features/categories/hooks/useCreateCategory.ts` — useMutation POST
- `src/features/categories/hooks/useUpdateCategory.ts` — useMutation PATCH
- `src/features/categories/hooks/useDeleteCategory.ts` — useMutation DELETE
- `src/features/categories/components/CategoryList.tsx` — lista com badge colorido e task_count
- `src/features/categories/components/CategoryForm.tsx` — formulario com nome + color picker (12 cores)
- `src/features/categories/components/CategoryColorPicker.tsx` — palette de 12 cores predefinidas
- `src/features/tasks/components/CategoryMultiSelect.tsx` — multi-select para uso no TaskDrawer
- `src/app/(dashboard)/categories/page.tsx` — pagina /categories
- Atualizar TaskDrawer (Story 2.1) para usar CategoryMultiSelect real
- Atualizar TaskCard (Story 2.1) para exibir badges coloridos das categorias

**OUT:**
- Categorias de workspace (Epic 3)
- Icones nas categorias
- Ordenacao de categorias
- Importacao/exportacao de categorias

---

## Dependencies

- **Story 2.1** — TaskRepository, useTasks, TaskCard, TaskDrawer existem e precisam ser atualizados
- **Story 1.2** — Tabelas categories e task_categories no schema do banco

---

## Complexity

**Estimativa:** 3 story points (S)

---

## Business Value

Categorias sao o sistema de organizacao primario. Sem elas as tarefas sao uma lista plana sem contexto. Essencial para users com muitas tarefas de diferentes projetos.

---

## Risks

- **DELETE com tarefas associadas:** Verificar task_categories antes de deletar; exibir AlertDialog shadcn com opcao de confirmar (remove associacoes) ou cancelar.
- **task_count na query:** Usar COUNT em JOIN ou subquery — verificar performance com RLS.
- **Multi-select max 5:** Validar no frontend e na API (task_categories INSERT).

---

## Definition of Done

- [x] Todos os ACs verificados manualmente
- [x] `npm run lint && npm run typecheck && npm run test` passando
- [x] CRUD de categorias funciona completo
- [x] Badges coloridos aparecem nas tarefas
- [x] Multi-select no TaskDrawer funciona com limite de 5
- [x] File List completo na story

---

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

---

## Tasks / Subtasks

- [x] **Task 1: CategoryRepository** (AC: 1, 2, 3)
  - [x] 1.1 Criar `src/lib/repositories/CategoryRepository.ts`
  - [x] 1.2 `list(userId)`: SELECT categorias + COUNT de task_categories (nao deletadas)
  - [x] 1.3 `create(userId, data)`: INSERT na tabela categories
  - [x] 1.4 `update(userId, id, data)`: UPDATE nome/cor
  - [x] 1.5 `delete(userId, id)`: verificar se tem tarefas; DELETE categoria e task_categories

- [x] **Task 2: Zod Schemas** (AC: 2)
  - [x] 2.1 Criar `src/features/categories/schemas/category.schema.ts`
  - [x] 2.2 `categoryCreateSchema`: name (min 2, max 50), color (string hex)
  - [x] 2.3 `categoryUpdateSchema`: Partial de createSchema

- [x] **Task 3: API Routes** (AC: 1, 2, 3)
  - [x] 3.1 Criar `src/app/api/categories/route.ts` — GET + POST
  - [x] 3.2 Criar `src/app/api/categories/[id]/route.ts` — PATCH + DELETE
  - [x] 3.3 DELETE: se categoria tem tarefas, retornar 409 com contagem para frontend decidir

- [x] **Task 4: React Query Hooks** (AC: 1, 2)
  - [x] 4.1 `useCategories.ts` — useQuery GET /api/categories; queryKey: ['categories']
  - [x] 4.2 `useCreateCategory.ts` — useMutation + invalidate categories
  - [x] 4.3 `useUpdateCategory.ts` — useMutation PATCH + invalidate categories
  - [x] 4.4 `useDeleteCategory.ts` — useMutation DELETE + invalidate categories + tasks

- [x] **Task 5: Color Picker** (AC: 2)
  - [x] 5.1 Criar `CategoryColorPicker.tsx` com 12 cores predefinidas:
        #ef4444, #f97316, #eab308, #22c55e, #14b8a6, #3b82f6,
        #6366f1, #8b5cf6, #ec4899, #64748b, #78716c, #0ea5e9
  - [x] 5.2 UI: grid 6x2 de circulos coloridos, selecionado tem borda/check

- [x] **Task 6: CategoryForm** (AC: 2)
  - [x] 6.1 Criar `CategoryForm.tsx` — nome (Input) + CategoryColorPicker
  - [x] 6.2 Validacao com React Hook Form + zodResolver
  - [x] 6.3 Usado em modal (Dialog shadcn) para criar e editar

- [x] **Task 7: CategoryList** (AC: 1, 2, 3)
  - [x] 7.1 Criar `CategoryList.tsx` — lista categorias com badge colorido, task_count, edit/delete
  - [x] 7.2 Botao editar: abre CategoryForm pre-populado
  - [x] 7.3 Botao deletar: se task_count > 0, mostrar AlertDialog; se 0, deletar direto

- [x] **Task 8: CategoryMultiSelect** (AC: 4, 5, 6)
  - [x] 8.1 Criar `CategoryMultiSelect.tsx` — multi-select com badges coloridos
  - [x] 8.2 Limite de 5 categorias por tarefa (desabilitar selecao quando atingido)
  - [x] 8.3 Integrar no TaskDrawer (substituir placeholder da Story 2.1)

- [x] **Task 9: Atualizar TaskCard** (AC: 5, 6)
  - [x] 9.1 Exibir badges coloridos usando cor da categoria
  - [x] 9.2 Click no badge: emitir evento para filtrar lista (passar filtro de categoria_id para useTasks)

- [x] **Task 10: Pagina /categories** (AC: 1, 2)
  - [x] 10.1 Criar `src/app/(dashboard)/categories/page.tsx`
  - [x] 10.2 Header com "Categorias" + botao "Nova Categoria"
  - [x] 10.3 Renderizar CategoryList

- [x] **Task 11: Verificacao final** (AC: 1-6)
  - [x] 11.1 `npm run lint && npm run typecheck && npm run test` passando
  - [x] 11.2 Build limpo
  - [x] 11.3 File List completo abaixo

---

## Dev Notes

### 12 Cores Predefinidas

```typescript
export const CATEGORY_COLORS = [
  { label: 'Vermelho',  value: '#ef4444' },
  { label: 'Laranja',   value: '#f97316' },
  { label: 'Amarelo',   value: '#eab308' },
  { label: 'Verde',     value: '#22c55e' },
  { label: 'Teal',      value: '#14b8a6' },
  { label: 'Azul',      value: '#3b82f6' },
  { label: 'Indigo',    value: '#6366f1' },
  { label: 'Roxo',      value: '#8b5cf6' },
  { label: 'Rosa',      value: '#ec4899' },
  { label: 'Cinza',     value: '#64748b' },
  { label: 'Marrom',    value: '#78716c' },
  { label: 'Ciano',     value: '#0ea5e9' },
] as const
```

### Badge Colorido

```tsx
<span
  className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
  style={{ backgroundColor: `${category.color}20`, color: category.color }}
>
  {category.name}
</span>
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story criada | @sm (River) |
| 2026-02-21 | 1.1 | Status Draft para Ready — GO (10/10). CRUD completo com color picker e multi-select bem delimitados. Risco de DELETE com tarefas documentado. Pronta para implementação. | @po (Pax) |
| 2026-02-21 | 1.2 | Implementação completa. lint ✅ typecheck ✅ tests 8/8 ✅ build ✅. Status → Done. | @dev (Dex) |

---

## File List

**A criar:**
- src/app/api/categories/route.ts
- src/app/api/categories/[id]/route.ts
- src/lib/repositories/CategoryRepository.ts
- src/features/categories/schemas/category.schema.ts
- src/features/categories/hooks/useCategories.ts
- src/features/categories/hooks/useCreateCategory.ts
- src/features/categories/hooks/useUpdateCategory.ts
- src/features/categories/hooks/useDeleteCategory.ts
- src/features/categories/components/CategoryList.tsx
- src/features/categories/components/CategoryForm.tsx
- src/features/categories/components/CategoryColorPicker.tsx
- src/features/tasks/components/CategoryMultiSelect.tsx
- src/app/(dashboard)/categories/page.tsx

**A modificar:**
- src/features/tasks/components/TaskDrawer.tsx — CategoryMultiSelect real
- src/features/tasks/components/TaskCard.tsx — badges coloridos + filtro click
- docs/stories/2.3.category-management.story.md
